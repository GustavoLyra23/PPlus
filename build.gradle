plugins {
    id 'org.jetbrains.kotlin.jvm' version '2.1.20'
    id 'antlr'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

group = 'org.gustavolyra'
version = '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

dependencies {
    testImplementation 'org.jetbrains.kotlin:kotlin-test'
    antlr 'org.antlr:antlr4:4.13.1'
    implementation 'org.antlr:antlr4-runtime:4.13.1'
}

generateGrammarSource {
    maxHeapSize = "64m"
    arguments += ['-visitor', '-package', 'org.gustavolyra.portugolpp']
    outputDirectory = file("$buildDir/generated-src/antlr/main")
}

sourceSets {
    main {
        java {
            srcDir "$buildDir/generated-src/antlr/main"
        }
    }
}

compileKotlin {
    dependsOn generateGrammarSource
}

clean {
    delete "$buildDir/generated-src"
}

test {
    useJUnitPlatform()
}

kotlin {
    jvmToolchain(21)
}

shadowJar {
    manifest {
        attributes 'Main-Class': 'MainKt'
    }
    archiveBaseName.set('portugolpp')
    archiveClassifier.set('')
    archiveVersion.set('')
}

// Create a wrapper batch file task
tasks.register('createExeWrapper') {
    dependsOn shadowJar
    doLast {
        def exeDir = file("${buildDir}/exe")
        exeDir.mkdirs()

        // Copy the JAR file
        copy {
            from "${buildDir}/libs/portugolpp.jar"
            into exeDir
        }

        // Create batch file wrapper
        def batchFile = new File(exeDir, "portugolpp.bat")
        batchFile.text = '''@echo off
title Portugol++
java -jar "%~dp0portugolpp.jar" %*
if ERRORLEVEL 1 pause
'''

        // Create README
        def readmeFile = new File(exeDir, "README.txt")
        readmeFile.text = '''Portugol++ Programming Language
===========================

Para usar:
- Duplo clique em portugolpp.bat para iniciar o modo interativo
- OU use "portugolpp.bat run arquivo.ppp" para executar um arquivo

Requisitos:
- Java 21 ou superior deve estar instalado e no PATH

Para mais informações, visite: https://github.com/seu-usuario/p_mais_mais
'''

        println "Wrapper files created in ${exeDir}"
    }
}